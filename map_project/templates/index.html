
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
   integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
   crossorigin=""/>
<style>
    #mapid {
    width: 400px;
    height: 600px;

    position: absolute;
    top:0;
    bottom: 0;
    left: 0;
    right: 0;

    margin: auto;
}
</style>

{% block content %}
{% csrf_token %}
    <div id="mapid"></div>
    <div style="text-align:center; margin-top:700px;">
        Distance (in kms): <input type="text" id="distance"/>
        <button id="calc_distance" type="button">Go</button>
        <ul id="eventlist" style="display:inline-table">

        </ul>
    </div>

{% endblock content %}

{% block scripts %}
<!--JavaScript libraries-->
    <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
   integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
   crossorigin=""></script>
<script src="static/js/jquery-3.2.1/js/jquery-3.2.1.min.js"></script>
<script>
    // Setting the map to california as most of the events are in that area.
    var mymap = L.map('mapid').setView([37.7749, -122.4194], 13);

BASEMAP_CONSTS = {
    'DATA_URL': 'https://mobilize-mock-api.herokuapp.com/api/events',
    'ACCESS_TOKEN': 'pk.eyJ1Ijoic29tZXVzZXJuYW1ld2hhdGlzdGhlcG9pbnQiLCJhIjoiY2o5NzJkb3czMDJuaTMybXF2MTk3ZTM1cyJ9.SoQvv0DNvw6j8170P6CBiw',
    'MAP_URL': 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}',
    'ATTRIBUTION': 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>'
};

L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    attribution: BASEMAP_CONSTS['ATTRIBUTION'],
    maxZoom: 18,
    id: 'mapbox.streets',
    accessToken: BASEMAP_CONSTS['ACCESS_TOKEN']
}).addTo(mymap);

$( "#calc_distance").click( function(data) {
    var inpDist = parseInt($("#distance").val());

    if ( $("#distance").val() === '' ) {
        alert("Please enter an integer value ");
        return;
    }

    $("#eventlist").text("");
    if ( mymap != undefined || mymap!=null) {
                        mymap.remove();

                        mymap = L.map('mapid').setView([37.7749, -122.4194], 13);
                        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                            attribution: BASEMAP_CONSTS['ATTRIBUTION'],
                            maxZoom: 18,
                            id: 'mapbox.streets',
                            accessToken: BASEMAP_CONSTS['ACCESS_TOKEN']
                        }).addTo(mymap);
                }
    $.getJSON(BASEMAP_CONSTS['DATA_URL'],
        function(data) {
        data.data.events.forEach(
            function(d) {

                var dist = calcCrow( 37.7749, -122.4194, d.location.latitude, d.location.longitude);

                if ( dist < inpDist) {
                    $("#eventlist").append('<li>Name: ' + d['name'] + ' Description: ' + d['description'] + '</li>');
                    var marker = L.marker([d.location.latitude, d.location.longitude])
            marker.bindPopup(d.tagline).openPopup();
            marker.addTo(mymap);
                }
            }
        )
    });
});

$.getJSON(BASEMAP_CONSTS['DATA_URL'],
    function(data) {
    $("#eventlist").text("");
    data.data.events.forEach(
        function(d) {

            $("#eventlist").append('<li>Name: ' + d['name'] + ' Description: ' + d['description'] + '</li>');

            var marker = L.marker([d.location.latitude, d.location.longitude])
            marker.bindPopup(d.tagline).openPopup();
            marker.addTo(mymap);

        }
    )
    }
);

//This function takes in latitude and longitude of two location and returns the distance between them as the crow flies (in km)
    function calcCrow(lat1, lon1, lat2, lon2)
    {
      var R = 6371; // km
      var dLat = toRad(lat2-lat1);
      var dLon = toRad(lon2-lon1);
      var lat1 = toRad(lat1);
      var lat2 = toRad(lat2);

      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      var d = R * c;
      return d;
    }

    // Converts numeric degrees to radians
    function toRad(Value)
    {
        return Value * Math.PI / 180;
    }

</script>
{% endblock scripts %}
